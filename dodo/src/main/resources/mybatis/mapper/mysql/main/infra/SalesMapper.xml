<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dodo.module.sales.SalesDao">
	<resultMap id="resultMapObj" type="com.dodo.module.sales.SalesDto"></resultMap>
	
	<!-- 공통 구문 selectCommon으로 선언 -->
	<sql id="selectCommon">
		FROM 
			memberSales a
			LEFT JOIN game b ON a.game_gSeq = b.gSeq
			LEFT JOIN member c ON a.member_mSeq = c.mSeq
		WHERE 1=1
			AND a.msDelNy = 0
			<if test="shStateCd != null and !shStateCd.equals('')">AND a.msStateCd = #{shStateCd}</if>			
			<choose>
				<when test="shOptionDate != null and !shOptionDate.equals('')
					and shOptionDate == 1
					and shDateStart != null and !shDateStart.equals('')
					and shDateEnd != null and !shDateEnd.equals('')">
					AND a.msRegiDate BETWEEN #{shDateStartDB} AND #{shDateEndDB}
				</when>
			</choose>				
	        <choose>
	            <when test="shOption == 1">AND b.gName LIKE CONCAT('%',#{shValue},'%')</when>
	            <when test="shOption == 2">AND c.mName LIKE CONCAT('%',#{shValue},'%')</when>
	        </choose>
		ORDER BY a.msSeq DESC
	</sql>
	
	<sql id="selectCommonColumn">
		a.msSeq,
		a.member_mSeq,
		a.game_gSeq,
		a.msTitle,
		a.msDesc,
		a.msPrice,
		a.msFee,
		a.msStateCd,
		a.msHit,
		a.bm_mSeq,
		a.msDeliName,
		a.msDelePostcode,
		a.msDeliRoadAddr,
		a.msDeliDetailAddr,
		a.msDeliTel,
		a.msDeliMemo, 
		a.msDeliComp,
		a.msDeliNo,
		a.msDeliStateCd,
		a.msRegiDate,
		a.msUpdtDate,
		b.gName,
		b.gCategoryCd,
		c.mName,
	    (SELECT d.fPath
			FROM memberPfFile d
			WHERE 1=1 
				AND c.mSeq = d.rSeq
	    ) as fPath
	</sql>
	
	<select id="selectListCount" resultType="Integer">
		SELECT COUNT(*)
		<include refid="selectCommon"/>
	</select>

	<select id="selectList" resultMap="resultMapObj">
		SELECT
			<include refid="selectCommonColumn"/>
		<include refid="selectCommon"/>
		
		LIMIT #{rowNumToShow} OFFSET #{startRnumForMysql}
	</select>
	
	<select id="selectOne" resultMap="resultMapObj">
		SELECT
			<include refid="selectCommonColumn"/>
		FROM 
			memberSales a
			LEFT JOIN game b ON a.game_gSeq = b.gSeq
			LEFT JOIN member c ON a.member_mSeq = c.mSeq
		WHERE 1=1
			AND a.msSeq=#{msSeq}
	</select>
	
	<update id="plusHit">
		UPDATE memberSales
		SET msHit = msHit + 1
		WHERE msSeq=#{msSeq};
	</update>
	
	<select id="insertCheck" resultType="Integer">
		SELECT COUNT(*) FROM 
			memberSales 
		WHERE 1=1
			AND member_mSeq=#{member_mSeq}
			AND game_gSeq=#{game_gSeq}
	</select>
	
	<insert id="insert">
		INSERT INTO memberSales
		(
			member_mSeq,
			game_gSeq,
			msTitle,
			msDesc,
			msPrice,
			msFee,
			msStateCd,
			msHit,
			msRegiDate,
			msDelNy
		)
		VALUES
		(
			#{member_mSeq},
		    #{game_gSeq},
		    #{msTitle},
		    #{msDesc},
		    #{msPrice},
		    #{msFee},
		    20,
		    0,
		   	now(),
		    0
		)
		
		<selectKey resultType="String" keyProperty="msSeq" order="AFTER">
			SELECT last_insert_id()
		</selectKey>
	</insert>
	
	<update id="update">
		UPDATE memberSales
		SET
			msTitle=#{msTitle},
			msDesc=#{msDesc},
			msPrice=#{msPrice},
			msFee=#{msFee},
			msUpdtDate=now()
		WHERE
			msSeq=#{msSeq}
	</update>
	
	<delete id="delete">
		DELETE FROM memberSales
		WHERE
			msSeq=#{msSeq}
	</delete>
	
</mapper>